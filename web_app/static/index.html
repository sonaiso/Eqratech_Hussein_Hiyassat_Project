<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¨ÙŠØ§Ù† â€“ ÙØ­Øµ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§</title>
    <style>
        :root {
            --primary: #1a56a0;
            --primary-light: #e8f0fb;
            --success: #166534;
            --success-bg: #dcfce7;
            --warn-bg: #fefce8;
            --error: #991b1b;
            --error-bg: #fee2e2;
            --border: #d1d5db;
            --bg: #f9fafb;
            --card-bg: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px 16px;
        }
        header {
            text-align: center;
            margin-bottom: 32px;
        }
        header h1 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 6px;
        }
        header p {
            color: var(--muted);
            font-size: 1rem;
        }
        .container { max-width: 860px; margin: 0 auto; }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,.06);
        }
        .card h2 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
        }
        label { display: block; font-weight: 600; margin-bottom: 6px; }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1.15rem;
            direction: rtl;
            resize: vertical;
            font-family: inherit;
            transition: border-color .2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); }
        .options { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
        .options input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
        .options label { font-weight: 500; cursor: pointer; margin-bottom: 0; }
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 28px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            margin-top: 16px;
            transition: background .2s, transform .1s;
        }
        .btn:hover { background: #1347a0; }
        .btn:active { transform: scale(.98); }
        .btn:disabled { background: #93a8c4; cursor: not-allowed; }
        .spinner {
            display: none;
            width: 18px; height: 18px;
            border: 3px solid rgba(255,255,255,.4);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #error-box {
            display: none;
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid #fca5a5;
            border-radius: var(--radius);
            padding: 12px 16px;
            margin-top: 12px;
        }
        #results { display: none; }
        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 99px;
            font-size: .8rem;
            font-weight: 700;
        }
        .badge-ok   { background: var(--success-bg); color: var(--success); }
        .badge-pass { background: var(--success-bg); color: var(--success); }
        .badge-repair { background: var(--warn-bg); color: #854d0e; }
        .badge-skip { background: #f3f4f6; color: var(--muted); }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 4px;
        }
        .stat-box {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
        }
        .stat-box .val { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: .75rem; color: var(--muted); margin-top: 2px; }
        table { width: 100%; border-collapse: collapse; font-size: .9rem; }
        th, td { text-align: right; padding: 8px 10px; border-bottom: 1px solid var(--border); }
        th { background: var(--primary-light); color: var(--primary); font-weight: 700; }
        tr:hover td { background: #f9fbff; }
        .morphology-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 14px;
            margin-bottom: 8px;
        }
        .morphology-item dt { font-weight: 600; color: var(--primary); }
        .morphology-item dd { margin-inline-start: 0; color: var(--muted); font-size: .9rem; margin-top: 2px; }
        .section-empty { color: var(--muted); font-size: .9rem; text-align: center; padding: 12px 0; }
        #health-dot {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #9ca3af;
            margin-inline-end: 6px;
            vertical-align: middle;
        }
        #health-dot.ok { background: #22c55e; }
        #health-dot.err { background: #ef4444; }
        footer {
            text-align: center;
            color: var(--muted);
            font-size: .8rem;
            margin-top: 32px;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ” Ø¨ÙŠØ§Ù† â€“ ÙØ­Øµ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h1>
        <p>Ø£Ø¯Ø®Ù„ Ù†ØµØ§Ù‹ Ø¹Ø±Ø¨ÙŠØ§Ù‹ Ù„ØªØ­Ù„ÙŠÙ„Ù‡ ÙˆÙØ­Øµ Ø·Ø¨Ù‚Ø§ØªÙ‡ Ø§Ù„ØµÙˆØªÙŠØ© ÙˆØ§Ù„ØµØ±ÙÙŠØ©</p>
        <p style="margin-top:6px;font-size:.85rem;">
            <span id="health-dot"></span><span id="health-label">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©â€¦</span>
        </p>
    </header>

    <!-- Input -->
    <div class="card">
        <h2>ğŸ“ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ¯Ø®ÙÙ„</h2>
        <label for="arabic-input">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ:</label>
        <textarea id="arabic-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù Ù…ÙÙÙÙŠØ¯ÙŒ">Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù Ù…ÙÙÙÙŠØ¯ÙŒ</textarea>
        <div class="options">
            <input type="checkbox" id="morphology-check" />
            <label for="morphology-check">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµØ±ÙÙŠ (C2b)</label>
        </div>
        <button class="btn" id="analyze-btn" onclick="runAnalysis()">
            <span class="spinner" id="spinner"></span>
            <span id="btn-text">â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„</span>
        </button>
        <div id="error-box"></div>
    </div>

    <!-- Results -->
    <div id="results">

        <!-- Stats -->
        <div class="card">
            <h2>â± Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
            <div class="stat-grid" id="stats-grid"></div>
        </div>

        <!-- C1 -->
        <div class="card">
            <h2>ğŸ”¤ Ø·Ø¨Ù‚Ø© C1 â€“ Ø§Ù„ØªØ±Ù…ÙŠØ² ÙˆØ§Ù„ØªÙ‚Ø·ÙŠØ¹</h2>
            <div id="c1-content"></div>
        </div>

        <!-- C2a -->
        <div class="card">
            <h2>ğŸµ Ø·Ø¨Ù‚Ø© C2a â€“ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</h2>
            <div id="c2a-content"></div>
        </div>

        <!-- C2b (shown only when requested) -->
        <div class="card" id="c2b-card" style="display:none;">
            <h2>ğŸ§© Ø·Ø¨Ù‚Ø© C2b â€“ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµØ±ÙÙŠ</h2>
            <div id="c2b-content"></div>
        </div>

    </div>
</div>

<footer>
    Ø¨ÙŠØ§Ù† â€“ Ù†Ø¸Ø§Ù… FVAFK Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© &nbsp;|&nbsp; Bayan Arabic NLP System
</footer>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function badgeFor(status) {
    const s = (status || '').toLowerCase();
    if (s === 'accept' || s === 'pass')   return `<span class="badge badge-pass">âœ” Ù…Ø±Øª</span>`;
    if (s === 'repair')                   return `<span class="badge badge-repair">ğŸ”§ Ø¥ØµÙ„Ø§Ø­</span>`;
    if (s === 'reject')                   return `<span class="badge badge-skip" style="background:#fee2e2;color:#991b1b">âœ˜ Ø±ÙÙØ¶Øª</span>`;
    if (s === 'skip')                     return `<span class="badge badge-skip">â­ ØªØ®Ø·ÙŠ</span>`;
    return `<span class="badge badge-skip">${esc(status)}</span>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Health check
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth() {
    try {
        const res = await fetch('/health');
        const dot   = document.getElementById('health-dot');
        const label = document.getElementById('health-label');
        if (res.ok) {
            const data = await res.json();
            dot.className = 'ok';
            label.textContent = `Ø§Ù„Ø®Ø¯Ù…Ø© ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ (Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${esc(data.version)})`;
        } else {
            dot.className = 'err';
            label.textContent = 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
        }
    } catch {
        const dot   = document.getElementById('health-dot');
        const label = document.getElementById('health-label');
        dot.className = 'err';
        label.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø©';
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
    const text = document.getElementById('arabic-input').value.trim();
    if (!text) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø¹Ø±Ø¨ÙŠ Ù„Ù„ØªØ­Ù„ÙŠÙ„.');
        return;
    }

    const morphology = document.getElementById('morphology-check').checked;
    setLoading(true);
    clearError();
    document.getElementById('results').style.display = 'none';

    try {
        const res = await fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, morphology }),
        });

        if (!res.ok) {
            const err = await res.json().catch(() => ({ detail: res.statusText }));
            throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        renderResults(data);
    } catch (e) {
        showError(`Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${esc(e.message)}`);
    } finally {
        setLoading(false);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(data) {
    renderStats(data.stats || {});
    renderC1(data.c1 || {});
    renderC2a(data.c2a || {});
    renderC2b(data.c2b);
    document.getElementById('results').style.display = 'block';
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

function renderStats(stats) {
    const grid = document.getElementById('stats-grid');
    const items = [
        { val: stats.c1_time_ms  != null ? stats.c1_time_ms.toFixed(2)  + ' ms' : 'â€”', lbl: 'ÙˆÙ‚Øª C1' },
        { val: stats.c2a_time_ms != null ? stats.c2a_time_ms.toFixed(2) + ' ms' : 'â€”', lbl: 'ÙˆÙ‚Øª C2a' },
        { val: stats.c2b_time_ms != null ? stats.c2b_time_ms.toFixed(2) + ' ms' : 'â€”', lbl: 'ÙˆÙ‚Øª C2b' },
        { val: stats.total_time_ms != null ? stats.total_time_ms.toFixed(2) + ' ms' : 'â€”', lbl: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' },
        { val: stats.gates_count != null ? stats.gates_count : 'â€”', lbl: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª' },
    ];
    grid.innerHTML = items.map(i =>
        `<div class="stat-box"><div class="val">${esc(String(i.val))}</div><div class="lbl">${esc(i.lbl)}</div></div>`
    ).join('');
}

function renderC1(c1) {
    const el = document.getElementById('c1-content');
    const count = c1.num_units != null ? c1.num_units : 'â€”';
    let html = `<p>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ÙØ±Ù…ÙÙ‘Ø²Ø©: <strong>${esc(String(count))}</strong></p>`;

    if (Array.isArray(c1.units) && c1.units.length) {
        html += `<br/><table>
            <thead><tr><th>#</th><th>Ø§Ù„Ø±Ù…Ø²</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th></tr></thead>
            <tbody>`;
        c1.units.forEach((u, i) => {
            html += `<tr>
                <td>${i + 1}</td>
                <td style="font-size:1.2rem">${esc(u.text || '')}</td>
                <td>${esc(u.category || '')}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
    }
    el.innerHTML = html;
}

function renderC2a(c2a) {
    const el = document.getElementById('c2a-content');
    const gates = Array.isArray(c2a.gates) ? c2a.gates : [];

    if (!gates.length) {
        el.innerHTML = '<p class="section-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨ÙˆØ§Ø¨Ø§Øª.</p>';
        return;
    }

    let html = `<table>
        <thead><tr><th>Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody>`;
    gates.forEach(g => {
        html += `<tr><td>${esc(g.gate || g.gate_name || '')}</td><td>${badgeFor(g.status)}</td></tr>`;
    });
    html += `</tbody></table>`;

    if (c2a.cv_pattern) {
        html += `<p style="margin-top:12px">Ø§Ù„Ù†Ù…Ø· CV: <strong>${esc(c2a.cv_pattern)}</strong></p>`;
    }
    el.innerHTML = html;
}

function renderC2b(c2b) {
    const card = document.getElementById('c2b-card');
    const el   = document.getElementById('c2b-content');

    if (!c2b) {
        card.style.display = 'none';
        return;
    }
    card.style.display = '';

    const words = Array.isArray(c2b.words) ? c2b.words : [];
    if (!words.length) {
        // Simple root/pattern display (web_app/main.py format)
        let html = '';
        if (c2b.root != null) {
            html += `<div class="morphology-item">
                <dt>Ø§Ù„Ø¬Ø°Ø±</dt>
                <dd>${esc(String(c2b.root))}</dd>
            </div>`;
        }
        if (c2b.pattern != null) {
            html += `<div class="morphology-item">
                <dt>Ø§Ù„ÙˆØ²Ù†</dt>
                <dd>${esc(String(c2b.pattern))}</dd>
            </div>`;
        }
        if (!html) html = '<p class="section-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ±ÙÙŠØ©.</p>';
        el.innerHTML = html;
        return;
    }

    let html = `<p>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø­Ù„Ù„Ø©: <strong>${esc(String(c2b.words_count != null ? c2b.words_count : words.length))}</strong></p><br/>`;
    words.forEach((w, i) => {
        html += `<div class="morphology-item">
            <dt>${i + 1}. ${esc(w.surface || w.word || '')}</dt>
            <dd>Ø§Ù„Ø¬Ø°Ø±: ${esc(w.root || 'â€”')} &nbsp;|&nbsp; Ø§Ù„ÙˆØ²Ù†: ${esc(w.pattern || 'â€”')} &nbsp;|&nbsp; Ø§Ù„Ù†ÙˆØ¹: ${esc(w.pos || 'â€”')}</dd>
        </div>`;
    });
    el.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI state helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
    document.getElementById('analyze-btn').disabled = on;
    document.getElementById('spinner').style.display = on ? 'block' : 'none';
    document.getElementById('btn-text').textContent  = on ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦' : 'â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„';
}

function showError(msg) {
    const box = document.getElementById('error-box');
    box.style.display = '';
    box.textContent = msg;
}

function clearError() {
    const box = document.getElementById('error-box');
    box.style.display = 'none';
    box.textContent = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Support Enter key
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('arabic-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) runAnalysis();
});

// Auto health check on load
checkHealth();
</script>
</body>
</html>
